!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasSelect=e()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};function e(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}var i=function(){return i=Object.assign||function(t){for(var e,i=1,s=arguments.length;i<s;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},i.apply(this,arguments)};function s(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var s,a,h=i.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(s=h.next()).done;)o.push(s.value)}catch(t){a={error:t}}finally{try{s&&!s.done&&(i=h.return)&&i.call(h)}finally{if(a)throw a.error}}return o}var a=function(t,e){this.label="1",this.coor=[],this.active=!1,this.creating=!1,this.dragging=!1,this.uuid=function(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++){var s=Math.floor(16*Math.random());t[i]=e.slice(s,s+1)}t[14]="4";var a=3&t[19]|8;return t[19]=e.slice(a,a+1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}(),this.index=e,Object.assign(this,t)},h=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=1,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){var t=s(this.coor,2),e=s(t[0],2),i=e[0],a=e[1],h=s(t[1],2),o=h[0],n=h[1];return[[i,a],[i+(o-i)/2,a],[o,a],[o,a+(n-a)/2],[o,n],[i+(o-i)/2,n],[i,n],[i,a+(n-a)/2]]},enumerable:!1,configurable:!0}),i}(a),o=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=2,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){return this.coor.length>2?this.coor:[]},enumerable:!1,configurable:!0}),i}(a),n=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=3,s}return e(i,t),i}(a),r=function(){function t(){this._eventTree={}}return t.prototype.on=function(t,e){var i=this._eventTree[t];Array.isArray(i)?i.push(e):this._eventTree[t]=[e]},t.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var a=this._eventTree[t];Array.isArray(a)&&a.forEach((function(t){return t.apply(void 0,function(t,e){for(var i=0,s=e.length,a=t.length;i<s;i++,a++)t[a]=e[i];return t}([],s(e)))}))},t.prototype.off=function(t,e){var i=this._eventTree[t],s=i.find((function(t){return t===e}));Array.isArray(i)&&s&&i.splice(s,1)},t}(),c=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=4,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){return this.coor.length>1?this.coor:[]},enumerable:!1,configurable:!0}),i}(a),l=function(t){function i(e,i){var s=t.call(this,e,i)||this;return s.type=5,s.radius=0,s.radius=e.radius||s.radius,s}return e(i,t),Object.defineProperty(i.prototype,"ctrlsData",{get:function(){var t=s(this.coor,2),e=t[0],i=t[1];return[[e,i-this.radius],[e+this.radius,i],[e,i+this.radius],[e-this.radius,i]]},enumerable:!1,configurable:!0}),i}(a),u="2.13.3";return function(t){function a(e,i){var s=t.call(this)||this;s.version=u,s.lock=!1,s.MIN_WIDTH=10,s.MIN_HEIGHT=10,s.MIN_RADIUS=5,s.strokeStyle="#0f0",s.fillStyle="rgba(0, 0, 255, 0.1)",s.lineWidth=1,s.activeStrokeStyle="#f00",s.activeFillStyle="rgba(255, 0, 0, 0.1)",s.ctrlStrokeStyle="#000",s.ctrlFillStyle="#fff",s.ctrlRadius=3,s.hideLabel=!1,s.labelFillStyle="#fff",s.labelFont="10px sans-serif",s.textFillStyle="#000",s.labelMaxLen=10,s.WIDTH=0,s.HEIGHT=0,s.isPolygonStartPoint=!1,s.dataset=[],s.remmberOrigin=[0,0],s.createType=0,s.ctrlIndex=-1,s.image=new Image,s.IMAGE_WIDTH=0,s.IMAGE_ORIGIN_HEIGHT=0,s.IMAGE_HEIGHT=0,s.originX=0,s.originY=0,s.scaleStep=0,s.scrollZoom=!0,s.dblTouch=300,s.dblTouchStore=0,s.alpha=!0,s.focusMode=!1,s.scaleTouchStore=0,s.isTouch2=!1,s.isMobile=navigator.userAgent.indexOf("Mobile")>-1,s.isStraigeLineX=!1,s.isStraigeLineY=!1,s.handleLoad=s.handleLoad.bind(s),s.handleContextmenu=s.handleContextmenu.bind(s),s.handleMousewheel=s.handleMousewheel.bind(s),s.handleMouseDown=s.handleMouseDown.bind(s),s.handelMouseMove=s.handelMouseMove.bind(s),s.handelMouseUp=s.handelMouseUp.bind(s),s.handelDblclick=s.handelDblclick.bind(s),s.handelKeyup=s.handelKeyup.bind(s);var a="string"==typeof e?document.querySelector(e):e;return a instanceof HTMLCanvasElement?(s.canvas=a,s.offScreen=document.createElement("canvas"),s.initSetting(),s.initEvents(),i&&s.setImage(i)):console.warn("HTMLCanvasElement is required!"),s}return e(a,t),Object.defineProperty(a.prototype,"activeShape",{get:function(){return this.dataset.find((function(t){return t.active}))||{}},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"scale",{get:function(){return this.IMAGE_ORIGIN_WIDTH&&this.IMAGE_WIDTH?this.IMAGE_WIDTH/this.IMAGE_ORIGIN_WIDTH:1},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"imageMin",{get:function(){return Math.min(this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},enumerable:!1,configurable:!0}),Object.defineProperty(a.prototype,"imageOriginMax",{get:function(){return Math.max(this.IMAGE_ORIGIN_WIDTH,this.IMAGE_ORIGIN_HEIGHT)},enumerable:!1,configurable:!0}),a.prototype.mergeEvent=function(t){var e=0,s=0,a=0,h=0;if(this.isMobile){var o=t.touches[0],n=o.clientX,r=o.clientY,c=t.target.getBoundingClientRect(),l=c.left,u=c.top;if(e=Math.round(n-l),s=Math.round(r-u),2===t.touches.length){var p=t.touches[1]||{},d=p.clientX,v=void 0===d?0:d,f=p.clientY,g=void 0===f?0:f;a=Math.round(Math.abs((v-n)/2+n)-l),h=Math.round(Math.abs((g-r)/2+r)-u)}}else e=t.offsetX,s=t.offsetY;return i(i({},t),{mouseX:e,mouseY:s,mouseCX:a,mouseCY:h})},a.prototype.handleLoad=function(){this.emit("load",this.image.src),this.IMAGE_ORIGIN_WIDTH=this.IMAGE_WIDTH=this.image.width,this.IMAGE_ORIGIN_HEIGHT=this.IMAGE_HEIGHT=this.image.height,this.fitZoom()},a.prototype.handleContextmenu=function(t){t.preventDefault(),this.evt=t,this.lock},a.prototype.handleMousewheel=function(t){if(t.stopPropagation(),this.evt=t,!this.lock&&this.scrollZoom){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY;this.mouse=[i,s],this.setScale(t.deltaY<0,!0)}},a.prototype.handleMouseDown=function(t){var e=this;if(t.stopPropagation(),this.evt=t,!this.lock){var i=this.mergeEvent(t),a=i.mouseX,r=i.mouseY,u=i.mouseCX,p=i.mouseCY,d=Math.round(a/this.scale),v=Math.round(r/this.scale);if(this.mouse=this.isMobile&&2===t.touches.length?[u,p]:[a,r],this.remmberOrigin=[a-this.originX,r-this.originY],!this.isMobile&&1===t.buttons||this.isMobile&&1===t.touches.length){var f=this.activeShape.ctrlsData||[];if(this.ctrlIndex=f.findIndex((function(t){return e.isPointInCircle(e.mouse,t,e.ctrlRadius)})),this.ctrlIndex>-1){var g=s(f[this.ctrlIndex],2),I=g[0],S=g[1];this.remmber=[[d-I,v-S]]}else if(this.isInBackground(t)){if(this.activeShape.creating){if([2,4].includes(this.activeShape.type))if(2===this.activeShape.type&&this.isPolygonStartPoint)this.activeShape.coor.push(this.activeShape.coor[0]),this.emit("add",this.activeShape),this.activeShape.creating=!1,this.isPolygonStartPoint=!1;else{var y=s(this.activeShape.coor[this.activeShape.coor.length-1],2),M=y[0],m=y[1];if(M!==d&&m!==v){var b=Math.round(d-this.originX/this.scale),x=Math.round(v-this.originY/this.scale);this.isStraigeLineY?b=this.activeShape.coor[this.activeShape.coor.length-1][0]:this.isStraigeLineX&&(x=this.activeShape.coor[this.activeShape.coor.length-1][1]),this.activeShape.coor.push([b,x])}}}else if(this.createType>0){var E=void 0,H=[b=Math.round(d-this.originX/this.scale),x=Math.round(v-this.originY/this.scale)];switch(this.createType){case 1:(E=new h({coor:[H,H]},this.dataset.length)).creating=!0;break;case 2:(E=new o({coor:[H]},this.dataset.length)).creating=!0;break;case 3:E=new n({coor:H},this.dataset.length),this.emit("add",E);break;case 4:(E=new c({coor:[H]},this.dataset.length)).creating=!0;break;case 5:(E=new l({coor:H},this.dataset.length)).creating=!0}this.dataset.forEach((function(t){t.active=!1})),E.active=!0,this.dataset.push(E)}else{var T=s(this.hitOnShape(this.mouse),2),G=T[0],_=T[1];if(console.warn("hitShapeIndex",G),console.warn("hitShape",_),G>-1){if(this.dataset.forEach((function(t,e){return t.active=e===G})),_.dragging=!0,this.dataset.splice(G,1),this.dataset.push(_),this.remmber=[],[3,5].includes(_.type)){var w=s(_.coor,2);M=w[0],m=w[1];this.remmber=[[d-M,v-m]]}else _.coor.forEach((function(t){e.remmber.push([d-t[0],v-t[1]])}));this.emit("select",_)}else this.activeShape.active=!1,this.dataset.sort((function(t,e){return t.index-e.index}))}this.update()}}}},a.prototype.handelMouseMove=function(t){if(t.stopPropagation(),this.evt=t,!this.lock){var e=this.mergeEvent(t),i=e.mouseX,a=e.mouseY,h=e.mouseCX,o=e.mouseCY;console.log("0mouseX："+i),console.log("0mouseY："+a),console.log("0mouseCX："+h),console.log("0mouseCY："+o);var n=Math.round(i/this.scale),r=Math.round(a/this.scale);if(console.log("0offsetX："+n),console.log("0offsetY："+r),console.log("0originX："+this.originX),console.log("0originY："+this.originY),this.mouse=this.isMobile&&2===t.touches.length?[h,o]:[i,a],(!this.isMobile&&1===t.buttons||this.isMobile&&1===t.touches.length)&&this.activeShape.type){if(this.ctrlIndex>-1&&(this.isInBackground(t)||5===this.activeShape.type)){var c=s(this.remmber,1),l=s(c[0],2),u=l[0],p=l[1];if(1===this.activeShape.type){var d=s(this.activeShape.coor,2),v=s(d[0],2),f=v[0],g=v[1],I=s(d[1],2),S=I[0],y=I[1],M=[];switch(this.ctrlIndex){case 0:M=[[n-u,r-p],[S,y]];break;case 1:M=[[f,r-p],[S,y]];break;case 2:M=[[f,r-p],[n-u,y]];break;case 3:M=[[f,g],[n-u,y]];break;case 4:M=[[f,g],[n-u,r-p]];break;case 5:M=[[f,g],[S,r-p]];break;case 6:M=[[n-u,g],[S,r-p]];break;case 7:M=[[n-u,g],[S,y]]}var m=s(M,2),b=s(m[0],2),x=b[0],E=b[1],H=s(m[1],2),T=H[0],G=H[1];T-x>=this.MIN_WIDTH&&G-E>=this.MIN_HEIGHT?this.activeShape.coor=M:this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than").concat(this.MIN_HEIGHT,"。"))}else if([2,4].includes(this.activeShape.type)){var _=[R=Math.round(n-this.originX/this.scale),N=Math.round(r-this.originY/this.scale)];this.activeShape.coor.splice(this.ctrlIndex,1,_)}else if(5===this.activeShape.type){var w=(R=Math.round(n-this.originX/this.scale))-this.activeShape.coor[0];w>=this.MIN_RADIUS&&(this.activeShape.radius=w)}}else if(this.activeShape.dragging){M=[];var k=!0,D=this.IMAGE_ORIGIN_WIDTH||this.WIDTH,W=this.IMAGE_ORIGIN_HEIGHT||this.HEIGHT;if([3,5].includes(this.activeShape.type)){var A=s(this.remmber[0],2),P=A[0];p=r-A[1];((u=n-P)<0||u>D||p<0||p>W)&&(k=!1),M=[u,p]}else for(var L=0;L<this.activeShape.coor.length;L++){var C=this.remmber[L];u=n-C[0],p=r-C[1];(u<0||u>D||p<0||p>W)&&(k=!1),M.push([u,p])}k&&(this.activeShape.coor=M)}else if(this.activeShape.creating&&this.isInBackground(t)){u=Math.round(n-this.originX/this.scale),p=Math.round(r-this.originY/this.scale);if(1===this.activeShape.type)this.activeShape.coor.splice(1,1,[u,p]);else if(5===this.activeShape.type){var X=s(this.activeShape.coor,2),Y=(f=X[0],g=X[1],Math.sqrt(Math.pow(f-u,2)+Math.pow(g-p,2)));this.activeShape.radius=Y}}this.update()}else if([2,4].includes(this.activeShape.type)&&this.activeShape.creating){this.isStraigeLineY=!1,this.isStraigeLineX=!1;var O=s(this.activeShape.coor[this.activeShape.coor.length-1],2);u=O[0],p=O[1];if(u!==n&&p!==r){var R=Math.round(n-this.originX/this.scale),N=Math.round(r-this.originY/this.scale);t.ctrlKey&&(Math.abs(u-R)-Math.abs(p-N)>0?(this.isStraigeLineX=!0,this.isStraigeLineY=!1):(this.isStraigeLineX=!1,this.isStraigeLineY=!0)),this.activeShape.coor.length>2&&(Math.abs(this.activeShape.coor[0][0]-R)<6&&Math.abs(this.activeShape.coor[0][1]-N)<6?this.isPolygonStartPoint=!0:this.isPolygonStartPoint=!1)}this.update()}else if(!this.isMobile&&2===t.buttons&&3===t.which||this.isMobile&&1===t.touches.length&&!this.isTouch2)this.originX=Math.round(i-this.remmberOrigin[0]),this.originY=Math.round(a-this.remmberOrigin[1]),this.update();else if(this.isMobile&&2===t.touches.length){this.isTouch2=!0;var j=t.touches[0],F=t.touches[1],U=this.scaleTouchStore;this.scaleTouchStore=Math.abs((F.clientX-j.clientX)*(F.clientY-j.clientY)),this.setScale(this.scaleTouchStore>U,!0)}}},a.prototype.handelMouseUp=function(t){if(t.stopPropagation(),this.evt=t,!this.lock){if(this.isMobile){if(0===t.touches.length&&(this.isTouch2=!1),Date.now()-this.dblTouchStore<this.dblTouch)return void this.handelDblclick(t);this.dblTouchStore=Date.now()}if(this.remmber=[],this.activeShape.type&&(this.activeShape.dragging=!1,this.activeShape.creating)){if(1===this.activeShape.type){var e=s(this.activeShape.coor,2),i=s(e[0],2),a=i[0],h=i[1],o=s(e[1],2),n=o[0],r=o[1];Math.abs(a-n)<this.MIN_WIDTH||Math.abs(h-r)<this.MIN_HEIGHT?(this.dataset.pop(),this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than ").concat(this.MIN_HEIGHT))):(this.activeShape.coor=[[Math.min(a,n),Math.min(h,r)],[Math.max(a,n),Math.max(h,r)]],this.activeShape.creating=!1,this.emit("add",this.activeShape))}else 5===this.activeShape.type&&(this.activeShape.radius<this.MIN_RADIUS?(this.dataset.pop(),this.emit("warn","Radius cannot be less than ".concat(this.MIN_WIDTH))):(this.activeShape.creating=!1,this.emit("add",this.activeShape)));this.update()}}},a.prototype.handelDblclick=function(t){t.stopPropagation(),this.evt=t,this.lock||[2,4].includes(this.activeShape.type)&&(2===this.activeShape.type&&this.activeShape.coor.length>2||4===this.activeShape.type&&this.activeShape.coor.length>1)&&(this.emit("add",this.activeShape),this.activeShape.creating=!1,this.update())},a.prototype.handelRightClick=function(t){console.warn("")},a.prototype.handelKeyup=function(t){t.stopPropagation(),this.evt=t,this.lock||document.activeElement!==document.body||this.activeShape.type&&([2,4].includes(this.activeShape.type)&&"Escape"===t.key?(this.activeShape.coor.length>1&&this.activeShape.creating?this.activeShape.coor.pop():this.deleteByIndex(this.activeShape.index),this.update()):("Delete"===t.key||"Backspace"===t.key)&&this.deleteByIndex(this.activeShape.index))},a.prototype.transformShape=function(t){var e,i=[];if("copy"==t)if([3,5].includes(this.activeShape.type)){var a=s(this.activeShape.coor,2),r=a[0],u=a[1];i=[[r+10,u+10]]}else this.activeShape.coor.forEach((function(t){i.push([t[0]-10,t[1]-10])}));else if("upsideDown"==t)if([3,5].includes(this.activeShape.type)){var p=s(this.activeShape.coor,2);r=p[0],u=p[1];i=[[r+10,u+10]]}else if(1==this.activeShape.type)this.activeShape.coor.forEach((function(t){i.push([t[0]-10,t[1]-10])}));else{var d=Number.MAX_VALUE,v=Number.MIN_VALUE;this.activeShape.coor.forEach((function(t){d=d<t[1]?d:t[1],v=v>t[1]?v:t[1]}));var f=d+v;this.activeShape.coor.forEach((function(t){i.push([t[0],f-t[1]])}))}else if("leftAndRight"==t)if([3,5].includes(this.activeShape.type)){var g=s(this.activeShape.coor,2);r=g[0],u=g[1];i=[[r+10,u+10]]}else if(1==this.activeShape.type)this.activeShape.coor.forEach((function(t){i.push([t[0]-10,t[1]-10])}));else{var I=Number.MAX_VALUE,S=Number.MIN_VALUE;this.activeShape.coor.forEach((function(t){I=I<t[0]?I:t[0],S=S>t[0]?S:t[0]}));var y=I+S;this.activeShape.coor.forEach((function(t){i.push([y-t[0],t[1]])}))}switch(this.activeShape.type){case 1:(e=new h({coor:[i[0],i[1]]},this.dataset.length)).label=this.activeShape.label,e.creating=!1;break;case 2:(e=new o({coor:i},this.dataset.length)).label=this.activeShape.label,e.creating=!1;break;case 3:(e=new n({coor:i[0]},this.dataset.length)).label=this.activeShape.label,this.emit("add",e);break;case 4:(e=new c({coor:i},this.dataset.length)).label=this.activeShape.label,e.creating=!1;break;case 5:(e=new l({coor:i[0]},this.dataset.length)).label=this.activeShape.label,e.radius=this.activeShape.radius,e.creating=!1}this.dataset.forEach((function(t){t.active=!1})),e.active=!0,this.dataset.push(e),this.update()},a.prototype.initSetting=function(){var t=window.devicePixelRatio||1;this.canvas.style.userSelect="none",this.ctx=this.ctx||this.canvas.getContext("2d",{alpha:this.alpha}),this.WIDTH=this.canvas.clientWidth,this.HEIGHT=this.canvas.clientHeight,this.canvas.width=this.WIDTH*t,this.canvas.height=this.HEIGHT*t,this.canvas.style.width=this.WIDTH+"px",this.canvas.style.height=this.HEIGHT+"px",this.offScreen.width=this.WIDTH,this.offScreen.height=this.HEIGHT,this.offScreenCtx=this.offScreenCtx||this.offScreen.getContext("2d",{willReadFrequently:!0}),this.ctx.scale(t,t)},a.prototype.initEvents=function(){this.image.addEventListener("load",this.handleLoad),this.canvas.addEventListener("touchstart",this.handleMouseDown),this.canvas.addEventListener("touchmove",this.handelMouseMove),this.canvas.addEventListener("touchend",this.handelMouseUp),this.canvas.addEventListener("contextmenu",this.handleContextmenu),this.canvas.addEventListener("mousewheel",this.handleMousewheel),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mousemove",this.handelMouseMove),this.canvas.addEventListener("mouseup",this.handelMouseUp),this.canvas.addEventListener("dblclick",this.handelDblclick),document.body.addEventListener("keyup",this.handelKeyup)},a.prototype.setImage=function(t){this.image.src=t},a.prototype.setData=function(t){var e=this;setTimeout((function(){var i=[];t.forEach((function(t,e){if(Object.prototype.toString.call(t).indexOf("Object")>-1){var s=void 0;switch(t.type){case 1:s=new h(t,e);break;case 2:s=new o(t,e);break;case 3:s=new n(t,e);break;case 4:s=new c(t,e);break;case 5:s=new l(t,e);break;default:console.warn("Invalid shape",t)}[1,2,3,4,5].includes(t.type)&&i.push(s)}else console.warn("Shape must be an enumerable Object.",t)})),e.dataset=i,e.update()}))},a.prototype.hitOnShape=function(t){for(var e,i=-1,s=this.dataset.length-1;s>-1;s--){var a=this.dataset[s];if(3===a.type&&this.isPointInCircle(t,a.coor,this.ctrlRadius)||5===a.type&&this.isPointInCircle(t,a.coor,a.radius*this.scale)||1===a.type&&this.isPointInRect(t,a.coor)||2===a.type&&this.isPointInPolygon(t,a.coor)||4===a.type&&this.isPointInLine(t,a.coor)){if(this.focusMode&&!a.active)continue;i=s,e=a;break}}return[i,e]},a.prototype.isMouseInshape=function(t){if(t.stopPropagation(),this.evt=t,!this.lock){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY,a=e.mouseCX,h=e.mouseCY;Math.round(i/this.scale),Math.round(s/this.scale),this.mouse=this.isMobile&&2===t.touches.length?[a,h]:[i,s]}},a.prototype.isInBackground=function(t){var e=this.mergeEvent(t),i=e.mouseX,s=e.mouseY;return i>=this.originX&&s>=this.originY&&i<=this.originX+this.IMAGE_ORIGIN_WIDTH*this.scale&&s<=this.originY+this.IMAGE_ORIGIN_HEIGHT*this.scale},a.prototype.isPointInRect=function(t,e){var i=this,a=s(t,2),h=a[0],o=a[1],n=s(e.map((function(t){return t.map((function(t){return t*i.scale}))})),2),r=s(n[0],2),c=r[0],l=r[1],u=s(n[1],2),p=u[0],d=u[1];return c+this.originX<=h&&h<=p+this.originX&&l+this.originY<=o&&o<=d+this.originY},a.prototype.isPointInPolygon=function(t,e){var i=this;this.offScreenCtx.save(),this.offScreenCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offScreenCtx.translate(this.originX,this.originY),this.offScreenCtx.beginPath(),e.forEach((function(t,e){var a=s(t.map((function(t){return Math.round(t*i.scale)})),2),h=a[0],o=a[1];0===e?i.offScreenCtx.moveTo(h,o):i.offScreenCtx.lineTo(h,o)})),this.offScreenCtx.closePath(),this.offScreenCtx.fill();var a=this.offScreenCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),h=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offScreenCtx.restore(),0!==a.data[h+3]},a.prototype.isPointInCircle=function(t,e,i){var a=this,h=s(t,2),o=h[0],n=h[1],r=s(e.map((function(t){return t*a.scale})),2),c=r[0],l=r[1];return Math.sqrt(Math.pow(c+this.originX-o,2)+Math.pow(l+this.originY-n,2))<=i},a.prototype.isPointInLine=function(t,e){var i=this;this.offScreenCtx.save(),this.offScreenCtx.clearRect(0,0,this.WIDTH,this.HEIGHT),this.offScreenCtx.translate(this.originX,this.originY),this.offScreenCtx.lineWidth=5,this.offScreenCtx.beginPath(),e.forEach((function(t,e){var a=s(t.map((function(t){return Math.round(t*i.scale)})),2),h=a[0],o=a[1];0===e?i.offScreenCtx.moveTo(h,o):i.offScreenCtx.lineTo(h,o)})),this.offScreenCtx.stroke();var a=this.offScreenCtx.getImageData(0,0,this.WIDTH,this.HEIGHT),h=(t[1]-1)*this.WIDTH*4+4*t[0];return this.offScreenCtx.restore(),0!==a.data[h+3]},a.prototype.drawRect=function(t){var e=this;if(2===t.coor.length){var i=t.strokeStyle,a=t.fillStyle,h=t.active,o=t.creating,n=t.coor,r=t.lineWidth,c=s(n.map((function(t){return t.map((function(t){return Math.round(t*e.scale)}))})),2),l=s(c[0],2),u=l[0],p=l[1],d=s(c[1],2),v=d[0],f=d[1];this.ctx.save(),this.ctx.lineWidth=r||this.lineWidth,this.ctx.fillStyle=a||this.fillStyle,this.ctx.strokeStyle=h||o?this.activeStrokeStyle:i||this.strokeStyle;var g=v-u,I=f-p;o||(this.ctx.fillRect(u,p,g,I),this.createType=0),this.ctx.strokeRect(u,p,g,I),this.ctx.restore()}},a.prototype.drawPolygon=function(t){var e=this,i=t.strokeStyle,a=t.fillStyle,h=t.active,o=t.creating,n=t.coor,r=t.lineWidth;this.ctx.save(),this.ctx.lineJoin="round",this.ctx.lineWidth=r||this.lineWidth,this.ctx.fillStyle=a||this.fillStyle,this.ctx.strokeStyle=h||o?this.activeStrokeStyle:i||this.strokeStyle,this.ctx.beginPath();var c=0,l=0;if(n.forEach((function(t,i){var a=s(t.map((function(t){return Math.round(t*e.scale)})),2),h=a[0],o=a[1];i===n.length-1&&(c=h,l=o),0===i?e.ctx.moveTo(h,o):e.ctx.lineTo(h,o)})),o){var u=s(this.mouse||[],2),p=u[0],d=u[1];this.isStraigeLineX?this.ctx.lineTo(p-this.originX,l):this.isStraigeLineY?this.ctx.lineTo(c,d-this.originY):this.ctx.lineTo(p-this.originX,d-this.originY)}else n.length>2&&(this.ctx.closePath(),this.createType=0);this.ctx.fill(),this.ctx.stroke(),this.ctx.restore()},a.prototype.drawDot=function(t){var e=this,i=t.strokeStyle,a=t.fillStyle,h=t.active,o=t.coor,n=t.lineWidth,r=s(o.map((function(t){return t*e.scale})),2),c=r[0],l=r[1];this.ctx.save(),this.ctx.lineWidth=n||this.lineWidth,this.ctx.fillStyle=a||this.ctrlFillStyle,this.ctx.strokeStyle=h?this.activeStrokeStyle:i||this.strokeStyle,this.ctx.beginPath(),this.ctx.arc(c,l,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(c,l,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},a.prototype.drawCirle=function(t){var e=this,i=t.strokeStyle,a=t.fillStyle,h=t.active,o=t.coor;t.label;var n=t.creating,r=t.radius;t.ctrlsData;var c=t.lineWidth,l=s(o.map((function(t){return t*e.scale})),2),u=l[0],p=l[1];this.ctx.save(),this.ctx.lineWidth=c||this.lineWidth,this.ctx.fillStyle=a||this.fillStyle,this.ctx.strokeStyle=h||n?this.activeStrokeStyle:i||this.strokeStyle,this.ctx.beginPath(),this.ctx.arc(u,p,r*this.scale,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(u,p,r*this.scale,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},a.prototype.drawLine=function(t){var e=this,i=t.strokeStyle,a=t.active,h=t.creating,o=t.coor,n=t.lineWidth;if(this.ctx.save(),this.ctx.lineJoin="round",this.ctx.lineWidth=n||this.lineWidth,this.ctx.strokeStyle=a||h?this.activeStrokeStyle:i||this.strokeStyle,this.ctx.beginPath(),o.forEach((function(t,i){var a=s(t.map((function(t){return Math.round(t*e.scale)})),2),h=a[0],o=a[1];0===i?e.ctx.moveTo(h,o):e.ctx.lineTo(h,o)})),h){var r=s(this.mouse||[],2),c=r[0],l=r[1];this.ctx.lineTo(c-this.originX,l-this.originY),this.createType=0}this.ctx.stroke(),this.ctx.restore()},a.prototype.drawCtrl=function(t){var e=this,i=s(t.map((function(t){return t*e.scale})),2),a=i[0],h=i[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=this.ctrlStrokeStyle,this.ctx.arc(a,h,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(a,h,this.ctrlRadius,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},a.prototype.drawPolygonStartPoint=function(t){var e=this,i=s(t.map((function(t){return t*e.scale})),2),a=i[0],h=i[1];this.ctx.save(),this.ctx.beginPath(),this.ctx.fillStyle=this.ctrlFillStyle,this.ctx.strokeStyle=this.ctrlStrokeStyle,this.ctx.arc(a,h,8,0,2*Math.PI,!0),this.ctx.fill(),this.ctx.arc(a,h,8,0,2*Math.PI,!0),this.ctx.stroke(),this.ctx.restore()},a.prototype.drawCtrlList=function(t){var e=this;t.ctrlsData.forEach((function(i,s){5===t.type?1===s&&e.drawCtrl(i):2===t.type&&e.isPolygonStartPoint&&0===s?e.drawPolygonStartPoint(i):e.drawCtrl(i)}))},a.prototype.drawLabel=function(t,e){var i=this,a=e.label,h=void 0===a?"":a,o=e.labelFillStyle,n=void 0===o?"":o,r=e.labelFont,c=void 0===r?"":r,l=e.textFillStyle,u=void 0===l?"":l,p=e.hideLabel,d=void 0!==p&&p;if(h.length&&!d&&!this.hideLabel){this.ctx.font=c||this.labelFont;var v=parseInt(this.ctx.font)+6,f=h.length<this.labelMaxLen+1?h:"".concat(h.slice(0,this.labelMaxLen),"..."),g=this.ctx.measureText(f),I=s(t.map((function(t){return t*i.scale})),2),S=I[0],y=I[1],M=this.IMAGE_ORIGIN_WIDTH-t[0]<(g.width+4)/this.scale,m=this.IMAGE_ORIGIN_HEIGHT-t[1]<v/this.scale;this.ctx.save(),this.ctx.fillStyle=n||this.labelFillStyle,this.ctx.fillRect(M?S-g.width-3:S+1,m?y-v+3:y+1,g.width+4,v),this.ctx.fillStyle=u||this.textFillStyle,this.ctx.fillText(f,M?S-g.width-2:S+2,m?y-3:y+v-4,180),this.ctx.restore()}},a.prototype.update=function(){var t=this;clearTimeout(this.timer),this.timer=setTimeout((function(){t.ctx.save(),t.ctx.clearRect(0,0,t.WIDTH,t.HEIGHT),t.ctx.translate(t.originX,t.originY),t.IMAGE_WIDTH&&t.IMAGE_HEIGHT&&t.ctx.drawImage(t.image,0,0,t.IMAGE_WIDTH,t.IMAGE_HEIGHT);for(var e=t.focusMode?t.activeShape.type?[t.activeShape]:[]:t.dataset,i=0;i<e.length;i++){var s=e[i];if(!s.hide)switch(s.type){case 1:t.drawRect(s);break;case 2:t.drawPolygon(s);break;case 3:t.drawDot(s);break;case 4:t.drawLine(s);break;case 5:t.drawCirle(s)}}[1,2,4,5].includes(t.activeShape.type)&&!t.activeShape.hide&&t.drawCtrlList(t.activeShape),t.ctx.restore(),t.emit("updated",t.dataset)}))},a.prototype.deleteByIndex=function(t){var e=this.dataset.findIndex((function(e){return e.index===t}));e>-1&&(this.emit("delete",this.dataset[e]),this.dataset.splice(e,1),this.dataset.forEach((function(t,e){t.index=e})),this.update())},a.prototype.clearAllMark=function(){for(var t=this.dataset.length;t>-1;)this.deleteByIndex(t),t--},a.prototype.calcStep=function(t){void 0===t&&(t=""),this.IMAGE_WIDTH<this.WIDTH&&this.IMAGE_HEIGHT<this.HEIGHT&&(""!==t&&"b"!==t||(this.setScale(!0,!1,!0),this.calcStep("b"))),(this.IMAGE_WIDTH>this.WIDTH||this.IMAGE_HEIGHT>this.HEIGHT)&&(""!==t&&"s"!==t||(this.setScale(!1,!1,!0),this.calcStep("s")))},a.prototype.setScale=function(t,e,i){if(void 0===e&&(e=!1),void 0===i&&(i=!1),!this.lock&&!(!t&&this.imageMin<=50||t&&this.IMAGE_WIDTH>=10*this.imageOriginMax)){t?this.scaleStep++:this.scaleStep--;var a=0,h=0,o=s(this.mouse||[],2),n=o[0],r=o[1];e&&(a=(n-this.originX)/this.scale,h=(r-this.originY)/this.scale);var c=Math.abs(this.scaleStep),l=this.IMAGE_WIDTH;if(this.IMAGE_WIDTH=Math.round(this.IMAGE_ORIGIN_WIDTH*Math.pow(this.scaleStep>=0?1.05:.95,c)),this.IMAGE_HEIGHT=Math.round(this.IMAGE_ORIGIN_HEIGHT*Math.pow(this.scaleStep>=0?1.05:.95,c)),e)this.originX=n-a*this.scale,this.originY=r-h*this.scale;else{var u=this.IMAGE_WIDTH/l;this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*u,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*u}i||this.update()}},a.prototype.fitZoom=function(){this.calcStep(),this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH)),this.originX=(this.WIDTH-this.IMAGE_WIDTH)/2,this.originY=(this.HEIGHT-this.IMAGE_HEIGHT)/2,this.update()},a.prototype.setFocusMode=function(t){this.focusMode=t,this.update()},a.prototype.destroy=function(){this.image.removeEventListener("load",this.handleLoad),this.canvas.removeEventListener("contextmenu",this.handleContextmenu),this.canvas.removeEventListener("mousewheel",this.handleMousewheel),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("touchend",this.handleMouseDown),this.canvas.removeEventListener("mousemove",this.handelMouseMove),this.canvas.removeEventListener("touchmove",this.handelMouseMove),this.canvas.removeEventListener("mouseup",this.handelMouseUp),this.canvas.removeEventListener("touchend",this.handelMouseUp),this.canvas.removeEventListener("dblclick",this.handelDblclick),document.body.removeEventListener("keyup",this.handelKeyup),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width=null,this.canvas.style.height=null,this.canvas.style.userSelect=null},a.prototype.resize=function(){this.canvas.width=null,this.canvas.height=null,this.canvas.style.width=null,this.canvas.style.height=null,this.initSetting(),this.update()},a}(r)}));
//# sourceMappingURL=canvas-select.min.js.map
